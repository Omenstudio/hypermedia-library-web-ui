var App={};App.doc="",App.connectToService=function(e){showOverlay(),$("#first-screen").css("display","none"),setTimeout(function(){var t=ServiceConnector.loadEntryPointAndDoc(e);for(var r in t)Models[t[r].itemId].collectionUrl=t[r].url;Renderer.updateMenu(t),Renderer.resetContentAreas(),$("#service-screen").css("display","block"),hideOverlay()},1),$("#current-service-url-info").text(e)},App.showCollectionForModel=function(e,t){showOverlay();var r=function(){var t=ServiceConnector.loadCollection(e,e.collectionUrl);Renderer.renderCollection(t,e),Renderer.resetItemArea(),$(".btn-add-entity").click(function(t){t.preventDefault(),Renderer.renderItemChange(e,e.collectionUrl),$(".datepicker").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearRange:"1800:2018"}),$("#save-form .items a td").each(function(){var e=$(this).html();$(this).closest("a").parent().html(e)}),$(".btn-select-item").click(function(e){e.preventDefault();var t=$(this).closest(".form-row").find(".items"),r=Models[t.attr("data-type")];App.showSelectDialog(r,function(e,r){t.html('<div class="item" data-url="'+e+'">'+r+"</div>"),t.find("a td").each(function(){var e=$(this).html();$(this).closest("a").parent().html(e)})})}),$(".btn-add-item").click(function(e){e.preventDefault();var t=$(this).closest(".form-row").find(".items"),r=Models[t.attr("data-type")];App.showSelectDialog(r,function(e,r){var o=!1;t.find(".item").each(function(){if($(this).attr("data-url")===e)return o=!0,0}),o||(t.append('<div class="item" data-url="'+e+'">'+r+"</div>"),t.find("a td").each(function(){var e=$(this).html();$(this).closest("a").parent().html(e)}))})}),$(".btn-clear-items").click(function(e){e.preventDefault(),$(this).closest(".form-row").find(".item").remove()}),$(".btn-cancel").click(function(){App.showItemForModel(item.url,e)}),$(".btn-save").click(function(){App.saveItemForModel($("#save-form"),!0),App.showCollectionForModel(e)})}),$(".service-item-list li a").click(function(t){t.preventDefault(),$(".service-item-list li").removeClass("active"),$(this).parent().addClass("active"),App.showItemForModel($(this).attr("href"),e),$("html, body").animate({scrollTop:$("#service-screen").offset().top},300)}),hideOverlay()};void 0!==t?r():setTimeout(r,1)},App.showItemForModel=function(e,t){showOverlay();setTimeout(function(){var r=ServiceConnector.loadItem(t,e);Renderer.renderItem(r,t),$(".popup").click(function(e){e.preventDefault();var t=Models[$(this).attr("data-model-id")],r=$(this).attr("href");$(".control-buttons .btn").removeClass("btn-primary"),$(t.collectionButtonSelector).addClass("btn-primary"),App.showCollectionForModel(t,!0),$(".service-item-list a").each(function(){if($(this).attr("href")===r)return $(this).parent().addClass("active"),0}),App.showItemForModel(r,t)}),$(".btn-edit").click(function(){Renderer.renderItemChange(t,r.url,r),$(".datepicker").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearRange:"1800:2018"}),$("#save-form .items a td").each(function(){var e=$(this).html();$(this).closest("a").parent().html(e)}),$("#save-form .items li a").each(function(){var e=$(this).html();$(this).parent().html(e)}),$(".btn-select-item").click(function(e){e.preventDefault();var t=$(this).closest(".form-row").find(".items"),r=Models[t.attr("data-type")];App.showSelectDialog(r,function(e,r){t.html('<div class="item" data-url="'+e+'">'+r+"</div>"),t.find("a td").each(function(){var e=$(this).html();$(this).closest("a").parent().html(e)})})}),$(".btn-add-item").click(function(e){e.preventDefault();var t=$(this).closest(".form-row").find(".items"),r=Models[t.attr("data-type")];App.showSelectDialog(r,function(e,r){var o=!1;t.find(".item").each(function(){if($(this).attr("data-url")===e)return o=!0,0}),o||(t.append('<div class="item" data-url="'+e+'">'+r+"</div>"),t.find("a td").each(function(){var e=$(this).html();$(this).closest("a").parent().html(e)}))})}),$(".btn-clear-items").click(function(e){e.preventDefault(),$(this).closest(".form-row").find(".item").remove()}),$(".btn-cancel").click(function(){App.showItemForModel(r.url,t)}),$(".btn-save").click(function(){App.saveItemForModel($("#save-form")),App.showItemForModel(r.url,t)})}),$(".btn-remove").click(function(){ServiceConnector.removeItem($(this).attr("href")),App.showCollectionForModel(t)}),hideOverlay()},1)},App.saveItemForModel=function(e,t){e.find(".item-select").each(function(){var e="";$(this).find(".item").each(function(){var t=$(this).attr("data-url").replace(new RegExp("-","g"),"/").split("/");e+=t[t.length-1]+", "}),""!==e&&(e=e.substr(0,e.length-2)),$(this).find("input").val(e)});var r={};e.find("input").each(function(){r[$(this).attr("name")]=$(this).val()}),void 0===t?ServiceConnector.saveItem(e.attr("data-url"),JSON.stringify(r)):ServiceConnector.addItem(e.attr("data-url"),JSON.stringify(r))},App.showSelectDialog=function(e,t){var r=ServiceConnector.loadCollection(e,e.collectionUrl),o=Renderer.buildCollectionHtml(r,e);showDialog("Select the "+e.simpleName,o,t)},App.initialize=function(){var e={};if(window.location.search.length>1)for(var t,r=0,o=window.location.search.substr(1).split("&");r<o.length;r++)t=o[r].split("="),e[unescape(t[0])]=t.length>1?unescape(t[1]):"";"url"in e&&$(".addressbar .url").val(e.url),$(".addressbar").submit(function(e){e.preventDefault();var t=$(this).find(".url").val().trim();{if(t.length)return 0!==t.indexOf("http")&&(t="http://"+t),App.connectToService(t),!1;alert("Please, enter valid URL")}}),$(".control-buttons .btn").click(function(){$(".control-buttons .btn").removeClass("btn-primary"),$(this).addClass("btn-primary");for(var e in Models)$(this).is(Models[e].collectionButtonSelector)&&App.showCollectionForModel(Models[e])}),$(".first-screen-wrapper a").click(function(e){e.preventDefault(),App.connectToService($(this).attr("href"))}),$("#service-screen").css("display","none")},$(document).ready(function(){hideOverlay(),App.initialize()});function showOverlay(){$("#overlay").css("display","grid")}function hideOverlay(){$("#overlay").css("display","none")}function showDialog(e,t,r){closeDialog();var o='<div class="center-point"><div class="dialog"><h2>'+e+'</h2><div class="dialog-content">'+t+'</div><button class="btn btn-danger btn-close-dialog">Cancel</button></div></div>';$("body").append(o),showOverlay(),$(".btn-close-dialog").click(function(e){e.preventDefault(),closeDialog()}),$(".dialog-content a").click(function(e){e.preventDefault();var t=$(this).closest("a"),o=t.attr("href");r(o,t.parent().clone().wrap("<div></div>").parent().html()),closeDialog()})}function closeDialog(){$(".dialog").remove(),hideOverlay()}var Renderer={};Renderer.updateMenu=function(e){for(var t in Models){var r=Models[t],o=$(r.collectionButtonSelector);o.removeAttr("disabled"),o.removeAttr("title"),""===r.collectionUrl&&(o.attr("disabled","disabled"),o.attr("title","Not mapped in current service"))}},Renderer.resetContentAreas=function(){Renderer.resetCollectionArea(),Renderer.resetItemArea()},Renderer.resetCollectionArea=function(){$(".service-item-list").html('<p class="tip">Please, select the menu item from top part of the screen</p>')},Renderer.resetItemArea=function(){$(".service-item-content").html('<p class="tip">Please, select the item to show from list in left part of the screen</p>')},Renderer.buildCollectionHtml=function(e,t){var r="<ul>";if(0!==e.length)for(var o in e){var n=e[o];r+=t.renderShortView(n)}else r+='<p class="tip">There are no '+t.simpleName+"s on the service</p>";return r+="</ul>"},Renderer.renderCollection=function(e,t){$(".service-item-list").html(Renderer.buildCollectionHtml(e,t));var r='<div class="btn-add-wrapper"><button class="btn btn-info btn-add-entity"><i class="fa fa-plus"></i> Add new '+t.simpleName+"</button></div>";$(".service-item-list").prepend(r)},Renderer.renderItem=function(e,t){var r=t.renderView(e),o="";ServiceConnector.isModelSupportOperation(t,"PUT")&&(o+='<button class="btn btn-warning btn-edit" href="'+e.url+'"><i class="fa fa-pencil"></i> Edit '+t.simpleName.toLowerCase()+"</button>"),ServiceConnector.isModelSupportOperation(t,"DELETE")&&(o+='<button class="btn btn-danger btn-remove" href="'+e.url+'"><i class="fa fa-trash"></i> Delete '+t.simpleName.toLowerCase()+"</button>"),o='<div class="item-control-buttons">'+o+"</div>",$(".service-item-content").html('<div class="item-wrapper">'+r+o+"</div>")},Renderer.renderItemChange=function(e,t,r){var o="Edit";void 0===r&&(o="Save");var n="<h2>"+o+" "+e.simpleName+"</h2>",i='<form id="save-form" data-url="'+t+'">',a=ServiceConnector.vocab[e.id].supportedProperties;for(var l in a)i+=Renderer.renderPropertyInput(a[l],e,r);i+="</form>";var s=e.collectionUrl;void 0!==r&&(s=r.url);var c=e.collectionUrl;void 0!==r&&(c=r.url);var d='<div class="item-control-buttons"><button class="btn btn-success btn-save href="'+s+'"><i class="fa fa-floppy-o"></i> Save</button><button class="btn btn-danger btn-cancel" href="'+c+'"><i class="fa fa-times"></i> Cancel</button></div>';$(".service-item-content").html('<div class="item-wrapper">'+n+i+d+"</div>")},Renderer.renderProperty=function(e,t){return void 0!==t?(-1!==e.toLowerCase().indexOf("date")&&(t=Renderer.formatDate(t)),"<tr><th>"+e+"</th><td>"+t+"</td></tr>"):""},Renderer.renderPropertyInput=function(e,t,r){var o=e.property,n=t.propertiesMap[o];if(void 0!==Models[o]){var i=Models[o],a="";return void 0!==(c=void 0===r?null:r[n])&&null!==c&&(a+='<div class="item" data-url="'+c.url+'">'+i.renderShortView(c)+"</div>"),'<div class="form-row item-select"><label>'+e.hydra_description+'</label><input name="'+e.hydra_title+'" hidden="hidden"/><div class="items" data-url="'+i.collectionUrl+'" data-type="'+i.id+'">'+a+'</div><div class="select-btns"><button class="btn btn-info btn-select-item">Select</button><button class="btn btn-info btn-clear-items">Clear</button></div></div>'}if(void 0!==ServiceConnector.collectionsMap[o]&&(o=ServiceConnector.collectionsMap[o],n=t.propertiesMap[o],void 0!==Models[o])){var l="";i=Models[o];if(void 0!==r)for(var s in r[n]){var c;l+='<div class="item" data-url="'+(c=r[n][s]).url+'">'+i.renderShortView(c)+"</div>"}return'<div class="form-row item-select"><label>'+e.hydra_description+'</label><input name="'+e.hydra_title+'" hidden="hidden"/><div class="items" data-url="'+i.collectionUrl+'" data-type="'+i.id+'">'+l+'</div><div class="select-btns"><button class="btn btn-info btn-add-item">Add</button><button class="btn btn-info btn-clear-items">Clear</button></div></div>'}var d="";return void 0!==r&&void 0!==r[n]&&(d=r[n]),-1!==e.property.toLowerCase().indexOf("date")?(d=Renderer.formatDate(d),'<div class="form-row"><label>'+e.hydra_description+'</label><input name="'+e.hydra_title+'" placeholder="'+n+'" value="'+d+'" class="datepicker" type="text" /></div>'):(d=d.toString().replace(/\"/g,"&quot;"),'<div class="form-row"><label>'+e.hydra_description+'</label><input name="'+e.hydra_title+'" placeholder="'+n+'" value="'+d+'" /></div>')},Renderer.formatDate=function(e){if(""===e)return"";var t=new Date(Date.parse(e)),r=t.getFullYear().toString(),o=(1+t.getMonth()).toString();1===o.length&&(o="0"+o);var n=t.getDate().toString();return 1===n.length&&(n="0"+n),r+"-"+o+"-"+n};function invokeRequest(e,t,r,o){var n={type:e||"GET",headers:o||{Accept:"application/ld+json, application/json;q=0.1"},processData:!1,data:r||null,dataType:"text",async:!1};return $.ajax("proxy.php?url="+encodeURI(t),n)}function invokeJsonRequest(e,t,r,o){var n={type:e||"GET",headers:{Accept:"application/ld+json, application/json;q=0.1"},processData:!1,data:r||null,dataType:"json",contentType:"application/json; charset=utf-8",async:!1};return $.ajax("proxy.php?url="+encodeURI(t),n)}function parseLinkHeader(e){var t={};if(!e||0===e.trim().length)return t;for(var r=e.split(","),o=r.length-1;o>=0;o--){for(var n,i,a=r[o].split(";"),l=a.length-1;l>=0;l--)if("<"===a[l].trim()[0])n=a[l].trim().slice(1,-1);else{var s=a[l].split("=");2===s.length&&"rel"===s[0].trim()&&(i=s[1].trim().slice(1,-1))}n&&i&&(t[i]=n)}return t}function parseDocumentationUrlAndLoad(e){var t=parseLinkHeader(e.getResponseHeader("Link"));return t["http://www.w3.org/ns/hydra/core#apiDocumentation"]||alert("Cannot find link to vocab header"),loadDocumentation(t["http://www.w3.org/ns/hydra/core#apiDocumentation"])}function loadDocumentation(e){var t={};return $.ajax({url:"proxy.php",dataType:"json",async:!1,data:{url:e,vocab:1},success:function(e){var r=e["@graph"];for(var o in r)t[r[o]["@id"]]=r[o]},error:function(){alert("Failed to parse vocab")}}),t}var ServiceConnector={};ServiceConnector.vocab="",ServiceConnector.collectionsMap={},ServiceConnector.loadEntryPointAndDoc=function(e){var t=[];return invokeRequest("GET",e).done(function(e,r,o){""===ServiceConnector.vocab&&(ServiceConnector.vocab=parseDocumentationUrlAndLoad(o)),e=JSON.parse(e),t=ServiceConnector._parseEntryPoint(e)}),t},ServiceConnector._parseEntryPoint=function(e){var t=[];for(var r in e)if("@"!==r[0]){var o=e[r],n=o.__value.__value["@id"],i=ServiceConnector.vocab[o.__iri].range,a=ServiceConnector.vocab[i].member_of;t.push({itemId:a,url:n})}return t},ServiceConnector.loadCollection=function(e,t){var r=[];return invokeRequest("GET",t).done(function(t,o,n){if(null!==(t=JSON.parse(t))){var i=t.members.__value;for(var a in i)r.push(ServiceConnector.parseResponseAsModelObject(e,i[a]))}}),r},ServiceConnector.loadItem=function(e,t){var r={};return invokeRequest("GET",t).done(function(t,o,n){t=JSON.parse(t),r=ServiceConnector.parseResponseAsModelObject(e,t)}),r},ServiceConnector.parseResponseAsModelObject=function(e,t){var r={};r.url=ServiceConnector.parseToId(t["@id"]),r.type=ServiceConnector.parseToId(t["@type"]);var o=ServiceConnector.vocab[r.type].supportedProperties;for(var n in t)if("@"!==n[0]){var i=t[n],a="";for(var l in o){var s=o[l];if(s.hydra_title===n){a=s.property;break}}var c=[];if(""===a||void 0===e.propertiesMap[a]){var d=i.__value;if(!(void 0!==d&&$.isArray(d)&&d.length>0))continue;var p=a;for(var u in d)0===c.length&&(a=ServiceConnector.parseToId(d[u]["@type"])),c.push(ServiceConnector.parseResponseAsModelObject(Models[a],d[u]));ServiceConnector.collectionsMap[p]=a}var h=e.propertiesMap[a],v="";try{v=c.length>0?c:ServiceConnector.parseToValue(i)}catch(e){try{var m=Models[i.__value["@type"]];void 0===m&&(m=Models[i.__iri]),v=ServiceConnector.parseResponseAsModelObject(m,i.__value)}catch(e){return r}}r[h]=v}return r},ServiceConnector.parseToId=function(e){for(;"string"!=typeof e;)if(void 0!==(e=e.__value)["@id"]){e=e["@id"];break}return e},ServiceConnector.parseToValue=function(e){for(;"object"==typeof e;)if(void 0!==(e=e.__value)["@value"]){e=e["@value"];break}return e},ServiceConnector.isModelSupportOperation=function(e,t){var r=ServiceConnector.vocab[e.id].supportedOperations;for(var o in r)if(r[o].method.toLowerCase()===t.toLowerCase())return!0;return!1},ServiceConnector.removeItem=function(e){return invokeRequest("DELETE",e)},ServiceConnector.saveItem=function(e,t){return invokeJsonRequest("PUT",e,t)},ServiceConnector.addItem=function(e,t){return invokeJsonRequest("POST",e,t)};var Article={};Article.id="http://schema.org/Article",Article.collectionUrl="",Article.collectionButtonSelector=".js-articles-btn",Article.simpleName="Article",Article.propertiesMap={"http://schema.org/headline":"title","http://schema.org/description":"description","http://schema.org/pageStart":"start page","http://schema.org/pageEnd":"end page","http://schema.org/wordCount":"number of words","http://schema.org/Person":"authors","http://schema.org/Book":"magazine"},Article.renderLinkView=function(e){return'<li><a href="'+e.url+'" class="popup" data-model-id="http://schema.org/Article">'+e.title+"</a></li>"},Article.renderShortView=function(e){var t='<li><a href="'+e.url+'">';if(void 0!==e.title&&(t+='<div class="short-article-title">'+e.title+"</div>"),void 0!==e.authors){var r="";for(var o in e.authors)r+=e.authors[o].name+", ";t+='<div class="short-article-authors">'+(r=r.substr(0,r.length-2))+"</div>"}return t+="</a></li>"},Article.renderView=function(e){var t="";if(void 0!==e.title&&(t+="<h2>"+e.title+"</h2>"),t+="<table>",void 0!==e.authors){t+="<tr><th>Authors:</th><td>";for(var r in e.authors)t+=Author.renderLinkView(e.authors[r]);t+="</td></tr>"}void 0!==e.magazine&&(t+=Book.renderLinkView(e.magazine,"Magazine")),t+=Renderer.renderProperty("Description:",e.description);var o="";return void 0!==e["start page"]&&(o+=e["start page"]),void 0!==e["end page"]&&(o+="-"+e["end page"]),t+=Renderer.renderProperty("Pages:",o),t+=Renderer.renderProperty("Number of words:",e["number of words"]),t+="</table>"};var Author={};Author.id="http://schema.org/Person",Author.collectionUrl="",Author.collectionButtonSelector=".js-authors-btn",Author.simpleName="Author",Author.propertiesMap={"http://schema.org/name":"name","http://schema.org/birthDate":"birthDate","http://schema.org/birthPlace":"birthPlace"},Author.renderLinkView=function(e){return'<li><a href="'+e.url+'" class="popup" data-model-id="http://schema.org/Person">'+e.name+"</a></li>"},Author.renderShortView=function(e){var t='<li><a href="'+e.url+'"><table>';return t+=Renderer.renderProperty("",e.name),t+="</table></a></li>"},Author.renderView=function(e){var t="";return void 0!==e.name&&(t+="<h2>"+e.name+"</h2>"),t+="<table>",t+=Renderer.renderProperty("Date of birth:",e.birthDate),t+=Renderer.renderProperty("Place of birth:",e.birthPlace),t+="</table>"};var Book={};Book.id="http://schema.org/Book",Book.collectionUrl="",Book.collectionButtonSelector=".js-books-btn",Book.simpleName="Book",Book.propertiesMap={"http://schema.org/headline":"title","http://schema.org/alternativeHeadline":"alternativeTitle","http://schema.org/description":"description","http://schema.org/copyrightYear":"copyrightYear","http://schema.org/bookEdition":"bookEdition","http://schema.org/numberOfPages":"numberOfPages","http://schema.org/isbn":"isbn","http://schema.org/Person":"authors","http://schema.org/Publisher":"publisher"},Book.renderLinkView=function(e,t){return void 0===t&&(t="Book"),"<tr><th>"+t+':</th><td><a href="'+e.url+'" class="popup" data-model-id="http://schema.org/Book">'+e.title+"</a></td></tr>"},Book.renderShortView=function(e){var t='<li><a href="'+e.url+'">';if(t+=Renderer.renderProperty("",e.title),t+='<div class="additional-book-info">',void 0!==e.authors){var r="";if($.isArray(e.authors))for(var o in e.authors)r+=e.authors[o].name+", ";else r+=e.authors.name+", ";t+='<div class="short-book-authors">written by '+(r=r.substr(0,r.length-2))+"</div>"}return void 0!==e.publisher&&(t+='<div class="short-book-publisher">published by '+e.publisher.name+"</div>"),t+="</div>",t+="</a></li>"},Book.renderView=function(e){var t="";if(void 0!==e.title&&(t+="<h2>"+e.title+"</h2>"),t+="<table>",void 0!==e.authors){if(t+="<tr><th>Written by:</th><td>",$.isArray(e.authors))for(var r in e.authors)t+=Author.renderLinkView(e.authors[r]);else t+=Author.renderLinkView(e.authors);t+="</td></tr>"}return void 0!==e.publisher&&(t+="<tr><th>Published by:</th><td>"+Publisher.renderLinkView(e.publisher)+"</td></tr>"),t+=Renderer.renderProperty("Alt. title:",e.alternativeTitle),t+=Renderer.renderProperty("Description:",e.description),t+=Renderer.renderProperty("Publish year:",e.copyrightYear),t+=Renderer.renderProperty("Page count:",e.numberOfPages),t+=Renderer.renderProperty("Edition:",e.bookEdition),t+=Renderer.renderProperty("ISBN:",e.isbn),t+="</table>"};var Publisher={};Publisher.id="http://schema.org/Publisher",Publisher.collectionUrl="",Publisher.collectionButtonSelector=".js-publishers-btn",Publisher.simpleName="Publisher",Publisher.propertiesMap={"http://schema.org/name":"name","http://schema.org/foundingDate":"foundingDate","http://schema.org/location":"location"},Publisher.renderLinkView=function(e){return'<li><a href="'+e.url+'" class="popup" data-model-id="http://schema.org/Publisher">'+e.name+"</a></li>"},Publisher.renderShortView=function(e){var t='<li><a href="'+e.url+'"><table>';return t+=Renderer.renderProperty("",e.name),t+="</table></a></li>"},Publisher.renderView=function(e){var t="";return void 0!==e.name&&(t+="<h2>"+e.name+"</h2>"),t+="<table>",t+=Renderer.renderProperty("Founding date:",e.foundingDate),t+=Renderer.renderProperty("Current location:",e.location),t+="</table>"};var Models={"http://schema.org/Article":Article,"http://schema.org/Person":Author,"http://schema.org/Book":Book,"http://schema.org/Publisher":Publisher};